secrets:
  image: 'turistforeningen/mongo-secrets:v1'
  tags:
    - staging
  volumes:
    - /secrets

setup:
  environment:
    - AWS_DEFAULT_REGION=eu-west-1
    - AWS_S3_BUCKET_NAME=turistforeningen
    - AWS_S3_BUCKET_PATH=/backups/mongo/
  image: 'turistforeningen/docker-mongo'
  tags:
    - staging
  volumes_from:
    - 'secrets:ro'

mongo-01:
  autoredeploy: true
  command: '--replSet "rs0"'
  image: 'mongo:3'
  restart: always
  tags:
    - staging

mongo-02:
  autoredeploy: true
  command: '--replSet "rs0"'
  image: 'mongo:3'
  restart: always
  tags:
    - staging

mongo-03:
  autoredeploy: true
  command: '--replSet "rs0"'
  image: 'mongo:3'
  restart: always
  tags:
    - staging

mongo-test:
  autoredeploy: true
  image: 'mongo:3'
  ports:
    - '27017'
  restart: always
  tags:
    - staging

mongo-backup-s3:
  autoredeploy: true
  environment:
    - BACKUP_INTERVAL=1
    - FILE_PREFIX=mongo-backup-
    - MONGO_DB=verdandi-prod
    - 'MONGO_HOST=rs0/mongo-01,mongo-02,mongo-03'
    - S3_BUCKET=turistforeningen
    - S3_PATH=backups/mongo-test/
  image: 'turistforeningen/mongo-backup-s3:test'
  restart: always
  tags:
    - staging
